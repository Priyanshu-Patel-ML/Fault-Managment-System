Memory_Stress_Test:
  schedule: "@once"
  start_date: "2025-01-20"
  description: "memory stress workflow increases post-storage-service container memory to almost nearing its limit of 256 M. This causes OOM in the container and it gets killed which causes continuous restarts. Due to continuous container restart, some of the post/compose REST API calls fails with 5xx error and nginx_http_response_5xx_errors_high alert gets generated."
  catchup: false
  default_view: "graph"
  orientation: "LR"
  max_active_runs: 1
  tags:
    - "target_system: compose-post-service"
    - "Severity: Medium"
    - "configured_duration: 300"

  default_args:
    owner: "airflow"
    depends_on_past: false
    retries: 1
    retry_delay_seconds: 60

  tasks:
    - task_id: memory_stress_test
      operator: airflow.providers.docker.operators.docker.DockerOperator
      image: "airflow_chaos:latest"
      api_version: "auto"
      auto_remove: true
      user: "root"
      mount_tmp_dir: false
      docker_url: "unix://var/run/docker.sock"
      network_mode: "host"
      container_name: "memory_stress_test"
      mounts:
        - source: "/home/azureuser/fault-injector/src/pod"
          target: "/opt/airflow/src/pod"
          type: "bind"
        - source: "/home/azureuser/.kube/config"
          target: "/root/.kube/config"
          type: "bind"
          read_only: true
      environment:
        KUBECONFIG: "/root/.kube/config"
        PYTHONPATH: "/opt/airflow/src/pod"
      command: >
        bash -c '
        cd /opt/airflow/src/pod &&
        chaos run memory_stress.json &&
        echo "[INFO] Memory stress test completed" &&
        sleep 10'

